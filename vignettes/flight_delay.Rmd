---
title: "flight_delay"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{flight_delay}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(lab4linreg)
```

### Introduction

This vignette demonstrates how to use the `ridgereg()` function to predict flight departure delays. We will use the `nycflights13` dataset, which contains information on all 336,776 flights that departed from New York City in 2013. The goal is to build a ridge regression model that predicts the departure delay (`dep_delay`) based on weather conditions and flight details.

### Data Loading and Preparation


```{r}
# Load required libraries
library(nycflights13)
library(dplyr)
library(tidyr)
```

The `flights` dataset contains the core information about each flight, and `weather` contains hourly meteorological data for the three NYC airports. We need to join these two datasets to create a single data frame for modeling. The join is performed on `year`, `month`, `day`, `hour`, and `origin` to link each flight to the weather conditions at its departure time and location.

```{r}
# Merge flight and weather data
flight_weather_data <- inner_join(
  flights, 
  weather, 
  by = c("origin", "year", "month", "day", "hour")
)
```

### Feature Selection and Cleaning

The combined dataset has many variables. We will select a subset that we believe may have predictive power for departure delays. We will also remove variables that are either identifiers (`tailnum`), redundant (`sched_dep_time`), or related to the arrival, since we are predicting departure delay (`arr_delay`, `arr_time`).

The selected predictors include:
*   **Flight details**: `month`, `day`, `dep_time`, `carrier`, `dest`, `distance`.
*   **Weather conditions**: `temp`, `dewp`, `humid`, `wind_dir`, `wind_speed`, `precip`, `pressure`, `visib`.

Our target variable is `dep_delay`.

```{r}

# Feature Selection and Engineering
selected_data <- flight_weather_data %>%
  # Select the original predictors plus wind_gust
  select(
    dep_delay, month, day, dep_time, carrier, dest, distance, 
    temp, dewp, humid, wind_dir, wind_speed, wind_gust, precip, pressure, visib
  ) %>%
  # Create interaction terms
  mutate(
    temp_x_humid = temp * humid,
    wind_x_precip = wind_speed * precip
  )

# Data cleaning: remove rows with NA values
# This is especially important now, as wind_gust has many missing values
cleaned_data <- selected_data %>%
  na.omit()

# Downsample the dataset
if (nrow(cleaned_data) > 10000) {
  set.seed(42) # for reproducibility
  final_data <- cleaned_data %>%
    sample_n(10000)
} else {
  final_data <- cleaned_data
}

# Display the first few rows to show the new interaction columns
head(final_data)
```

This completes the first step of preparing the data. The `final_data` data frame is now ready to be used with the `ridgereg` function to build our predictive model. The next steps would involve fitting the model and evaluating its predictions.
